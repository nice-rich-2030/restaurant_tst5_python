# 飲食店検索Webアプリ 仕様書 (SPEC.md)

## 1.1 課題分析・機能提案

### 課題
- Google AI（Gemini）のグラウンディングサーチ機能を使用した飲食店検索の動作検証が必要
- 検索結果の精度（ユーザー要求との合致度）を定量的に評価する仕組みがない
- API呼び出しの過程やレスポンスを詳細に確認できる検証環境が必要

### 解決策
- ユーザー入力テキストからGoogle Grounding Searchで飲食店を検索
- 各店舗について個別に詳細検索を実行し、合致度を5段階で判定
- 各処理ステップでプロンプト・レスポンスを詳細表示し、デバッグ・検証を容易に

### 潜在的課題の提案
- API呼び出し回数の制限（レート制限）への対応
- 検索結果の品質がプロンプト設計に大きく依存
- 10件順次処理のため応答時間が長くなる可能性

### 主要機能
| 機能分類 | 機能名 | 説明 |
|---------|--------|------|
| 入力 | テキスト入力 | ユーザーが飲食店検索条件を自由入力 |
| 処理 | 初回グラウンディングサーチ | 入力から10件の飲食店を検索 |
| 処理 | 店舗名抽出 | 検索結果からAIで店舗名を抽出 |
| 入力 | 店舗選択 | ユーザーが詳細検索対象の店舗を選択（チェックボックス） |
| 処理 | 個別店舗サーチ | 選択された店舗を順次詳細検索 |
| 処理 | 合致度判定 | 検索結果と入力の合致度を5段階判定 |
| 出力 | 詳細表示 | 各ステップのプロンプト・結果を表示 |
| メンテナンス | ログ出力 | バックエンド・フロントエンドのデバッグログ |

---

## 1.2 技術スタック選定・選定根拠

| 分類 | 技術 | 選定根拠 |
|------|------|----------|
| **バックエンド言語** | Python 3.11+ | Google AI SDK（google-generativeai）の公式サポート |
| **バックエンドFW** | FastAPI | 非同期処理、自動APIドキュメント生成、型安全性 |
| **フロントエンド** | HTML + Vanilla JavaScript | シンプルな検証用途、追加ビルド不要 |
| **CSSフレームワーク** | なし（カスタムCSS） | 軽量、検証目的に十分 |
| **Google AI SDK** | google-genai | Gemini API + Grounding Search対応（新SDK） |
| **ログ管理** | Python logging | 標準ライブラリ、ファイル＋コンソール出力対応 |
| **環境変数管理** | python-dotenv | .envファイルからAPIキー読み込み |
| **CORS対応** | fastapi[cors] | フロントエンドとバックエンド間通信 |

---

## 1.3 機能詳細化 (ブレイクダウン)

### 主要機能1: テキスト入力・表示
- 1.1 入力テキストエリアの提供
- 1.2 検索実行ボタン
- 1.3 入力内容・使用プロンプト・モデル名の詳細表示

### 主要機能2: 初回グラウンディングサーチ（10件飲食店取得）
- 2.1 入力テキストからプロンプト生成
- 2.2 Gemini API + Grounding Search呼び出し
- 2.3 サーチ結果の詳細表示（生レスポンス含む）

### 主要機能3: 店舗名抽出・店舗選択
- 3.1 サーチ結果テキストからAIで店舗名を10件抽出
- 3.2 抽出プロンプト・結果の詳細表示
- 3.3 店舗リストの構造化（JSON形式）
- 3.4 各店舗にチェックボックスを表示（デフォルト: 全選択）
- 3.5 ユーザーが詳細検索対象の店舗を選択/解除
- 3.6 「個別店舗サーチ開始」ボタンを表示

### 主要機能4: 個別店舗サーチ（順次実行）
- 4.1 選択された店舗に対する検索プロンプト生成（入力テキスト＋店舗名）
- 4.2 Grounding Search呼び出し（選択店舗を順次処理）
- 4.3 各店舗サーチ結果の詳細表示

### 主要機能5: 合致度判定
- 5.1 各店舗結果と入力テキストの合致度をAI判定
- 5.2 5段階評価（1:まったく合致しない ～ 5:完全に合致）
- 5.3 判定理由・結果の詳細表示
- 5.4 全店舗の判定結果サマリー表示

### 主要機能6: ログ・デバッグ機能
- 6.1 バックエンド：処理単位ごとのログ（コンソール＋ファイル）
- 6.2 フロントエンド：API呼び出し・結果取得のコンソールログ

---

## 1.4 データモデル・データ構造定義

### リクエスト/レスポンス構造（API通信）

```
SearchRequest:
  - input_text: string          # ユーザー入力テキスト

InitialSearchResponse:
  - input_text: string          # 入力テキスト
  - prompt: string              # 使用したプロンプト
  - model_name: string          # 使用モデル名
  - raw_response: string        # Gemini生レスポンス
  - grounding_metadata: object  # グラウンディング情報

ShopListResponse:
  - prompt: string              # 抽出プロンプト
  - shops: array[string]        # 店舗名リスト（10件）
  - raw_response: string        # AIレスポンス

ShopDetailRequest:
  - input_text: string          # 元の入力テキスト
  - selected_shops: array[string]  # 選択された店舗名リスト

ShopDetailSearchResponse:
  - shop_name: string           # 店舗名
  - prompt: string              # 検索プロンプト
  - raw_response: string        # サーチ結果
  - grounding_metadata: object  # グラウンディング情報

MatchJudgementResponse:
  - shop_name: string           # 店舗名
  - prompt: string              # 判定プロンプト
  - score: int (1-5)            # 合致度スコア
  - reason: string              # 判定理由
  - raw_response: string        # AIレスポンス

FullResultResponse:
  - initial_search: InitialSearchResponse
  - shop_list: ShopListResponse
  - shop_details: array[ShopDetailSearchResponse]
  - judgements: array[MatchJudgementResponse]
  - summary: object             # 全体サマリー
```

---

## 1.5 ユーザー操作シナリオ

### インストール・起動
1. リポジトリをクローン
2. `pip install -r requirements.txt` で依存関係インストール
3. `.env` ファイルに `GOOGLE_API_KEY=xxx` を設定
4. `python -m uvicorn main:app --reload` でバックエンド起動
5. ブラウザで `http://localhost:8000` にアクセス

### 利用フロー
1. 入力テキストエリアに検索条件を入力（例：「渋谷駅周辺でラーメンが美味しい店」）
2. 「検索開始」ボタンをクリック
3. 以下がステップごとに表示される：
   - Step1: 入力内容・プロンプト・モデル名
   - Step2: 初回サーチ結果（10件飲食店）
   - Step3: 抽出された店舗リスト（チェックボックス付き）
4. Step3完了後、ユーザーが詳細検索対象の店舗を選択（デフォルト全選択）
5. 「個別店舗サーチ開始」ボタンをクリック
6. 以下がステップごとに表示される：
   - Step4: 各店舗の個別サーチ結果（選択店舗のみ順次表示）
   - Step5: 各店舗の合致度判定結果
7. 全処理完了後、サマリー（平均スコアなど）表示

### 終了
- ブラウザを閉じる
- バックエンドは Ctrl+C で停止

---

## 1.6 UI分析・提案

### 画面レイアウト（単一ページ構成）

```
+----------------------------------------------------------+
|  飲食店検索 検証アプリ                                     |
+----------------------------------------------------------+
|                                                          |
|  [入力テキストエリア（複数行）                             ]|
|                                                          |
|  [ 検索開始 ]                                            |
|                                                          |
+----------------------------------------------------------+
|  ▼ Step 1: 入力詳細                                      |
|  +------------------------------------------------------+|
|  | 入力テキスト: ...                                     ||
|  | プロンプト: ...                                       ||
|  | モデル名: ...                                         ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+
|  ▼ Step 2: 初回サーチ結果                                |
|  +------------------------------------------------------+|
|  | [展開/折りたたみ可能な詳細表示]                        ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+
|  ▼ Step 3: 店舗リスト（詳細検索対象を選択）               |
|  +------------------------------------------------------+|
|  | [✓] 1. 店舗A                                         ||
|  | [✓] 2. 店舗B                                         ||
|  | [✓] 3. 店舗C                                         ||
|  | [ ] 4. 店舗D  ← ユーザーが解除可能                   ||
|  | ...                                                   ||
|  | [全選択] [全解除]                                     ||
|  +------------------------------------------------------+|
|                                                          |
|  [ 個別店舗サーチ開始 ]  ← Step3完了後に有効化           |
|                                                          |
+----------------------------------------------------------+
|  ▼ Step 4: 個別店舗サーチ                                |
|  +------------------------------------------------------+|
|  | [店舗1] プロンプト: ... 結果: ...                     ||
|  | [店舗2] プロンプト: ... 結果: ...                     ||
|  | ...（選択された店舗のみ表示）                          ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+
|  ▼ Step 5: 合致度判定                                    |
|  +------------------------------------------------------+|
|  | [店舗1] スコア: 4/5 理由: ...                         ||
|  | [店舗2] スコア: 3/5 理由: ...                         ||
|  | ...                                                   ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+
|  ▼ サマリー                                              |
|  +------------------------------------------------------+|
|  | 平均スコア: 3.5/5                                     ||
|  | 最高: 店舗A (5/5)  最低: 店舗B (2/5)                  ||
|  +------------------------------------------------------+|
+----------------------------------------------------------+
```

### エラーハンドリング・ステータス表示
- API呼び出し中はローディングインジケーター表示
- エラー発生時は該当ステップにエラーメッセージ表示（処理継続可能な場合は継続）
- 各ステップ完了時にチェックマーク表示

---

## 1.7 フォルダ・ファイル構成

```
restaurant_tst5_python/
├── .env                        # 環境変数（APIキー）※gitignore
├── .env.example                # 環境変数テンプレート
├── .gitignore                  # Git除外設定
├── requirements.txt            # Python依存関係
├── main.py                     # FastAPIエントリーポイント（~100行）
├── app/
│   ├── __init__.py
│   ├── config.py               # 設定管理（~50行）
│   ├── logger.py               # ログ設定（~80行）
│   ├── routers/
│   │   ├── __init__.py
│   │   └── search.py           # 検索API（~150行）
│   ├── services/
│   │   ├── __init__.py
│   │   ├── gemini_service.py   # Gemini API呼び出し（~200行）
│   │   └── search_service.py   # 検索ロジック（~250行）
│   └── schemas/
│       ├── __init__.py
│       └── search.py           # Pydanticスキーマ（~100行）
├── static/
│   ├── index.html              # フロントエンドHTML（~150行）
│   ├── style.css               # スタイルシート（~150行）
│   └── app.js                  # フロントエンドJS（~300行）
└── logs/
    └── app.log                 # アプリケーションログ
```

**行数目安**: 各ファイル800行以下を厳守

---

## 1.8 実装概要

| ファイル | 役割 | 処理概要 |
|---------|------|----------|
| `main.py` | エントリーポイント | FastAPIアプリ初期化、静的ファイル配信、ルーター登録 |
| `app/config.py` | 設定管理 | 環境変数読み込み、APIキー管理 |
| `app/logger.py` | ログ設定 | コンソール＋ファイルロガー設定 |
| `app/routers/search.py` | APIエンドポイント | POST /api/search（初回検索）, POST /api/search/detail（個別店舗検索） |
| `app/services/gemini_service.py` | Gemini API連携 | Grounding Search呼び出し、AI判定呼び出し |
| `app/services/search_service.py` | 検索ロジック | 全体フロー制御、各ステップ実行 |
| `app/schemas/search.py` | データスキーマ | リクエスト/レスポンスのPydanticモデル |
| `static/index.html` | UI構造 | 入力フォーム、結果表示エリア |
| `static/style.css` | スタイル | レイアウト、展開/折りたたみUI |
| `static/app.js` | フロントエンドロジック | API呼び出し、結果レンダリング、デバッグログ |

---

## 1.9 メンテナンス・セキュリティ

### ログ出力仕様

#### バックエンド（Python）
```
フォーマット: [%(asctime)s] %(levelname)s - %(name)s - %(message)s
出力先: コンソール + logs/app.log
レベル: DEBUG

出力タイミング（10行程度の処理単位の開始部）:
- 初回グラウンディングサーチ開始時: 入力テキスト、プロンプト、モデル名
- 店舗名抽出開始時: 抽出対象テキスト長
- 個別店舗サーチ開始時: 店舗名、プロンプト
- 合致度判定開始時: 店舗名、判定対象テキスト長
```

#### フロントエンド（JavaScript）
```
フォーマット: [YYYY-MM-DD HH:mm:ss.SSS] [処理名] 主要変数
出力先: ブラウザコンソール
レベル: DEBUG

出力タイミング:
- API呼び出し開始時: エンドポイント、リクエストボディ
- API結果取得時: ステータス、レスポンスサイズ
- 各ステップ表示開始時: ステップ名、データ概要
```

### セキュリティ対策
| 対策項目 | 実装方法 |
|---------|----------|
| APIキー保護 | .envファイル管理、.gitignoreで除外 |
| 入力検証 | Pydanticによるバリデーション |
| CORS設定 | 開発環境のみlocalhost許可 |
| エラー情報 | 本番環境では詳細エラーを非表示 |

### デバッグ機能
- 各APIレスポンスに生データ（raw_response）を含む
- グラウンディングメタデータの詳細表示
- 処理時間の計測・表示
