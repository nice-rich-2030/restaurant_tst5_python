# 飲食店検索Webアプリ 仕様書 VER1.0 (実装版)

**作成日**: 2026-01-19
**バージョン**: 1.1 (実装完了版 + 機能追加)
**変更履歴**:
- 計画版(SPEC.md)から実装時の変更点を反映
- 2026-01-19: ソースURL表示機能を追加（v1.1）

---

## 変更サマリー

| 項目 | 計画版 | 実装版 | 変更理由 |
|------|--------|--------|----------|
| モデル名 | gemini-2.0-flash-exp | gemini-2.5-flash | 最新の安定版モデルを使用 |
| チェックボックスデフォルト | 全選択 | 全未選択 | ユーザーが明示的に選択する設計に変更 |
| JudgementスコアのLiteral型 | Literal[1,2,3,4,5] | int (ge=1, le=5) | JSON Schema変換の互換性を考慮 |
| レスポンスフィールド名 | prompt | prompt_used | 命名の明確化 |

## 機能追加（v1.1）

| 日付 | 機能 | 説明 | 実装内容 |
|------|------|------|----------|
| 2026-01-19 | ソースURL表示 | Step 4の各店舗詳細サーチ結果の下に、グラウンディング検索の参照元URLを表示 | groundingMetadata.groundingChunksからURLとタイトルを抽出し、クリック可能なリンクとして表示 |

---

## 1.1 課題分析・機能提案

### 課題
- Google AI（Gemini）のグラウンディングサーチ機能を使用した飲食店検索の動作検証が必要
- 検索結果の精度（ユーザー要求との合致度）を定量的に評価する仕組みがない
- API呼び出しの過程やレスポンスを詳細に確認できる検証環境が必要

### 解決策
- ユーザー入力テキストからGoogle Grounding Searchで飲食店を検索
- 各店舗について個別に詳細検索を実行し、合致度を5段階で判定
- 各処理ステップでプロンプト・レスポンスを詳細表示し、デバッグ・検証を容易に

### 潜在的課題への対応（実装済み）
- ✅ **API呼び出し回数の制限（レート制限）への対応**: 500ms間隔で順次処理
- ✅ **検索結果の品質がプロンプト設計に大きく依存**: 詳細なプロンプトテンプレートを実装
- ✅ **10件順次処理のため応答時間が長くなる可能性**: ローディング表示とプログレス通知で対応

### 主要機能（全て実装済み）
| 機能分類 | 機能名 | 説明 | 実装状況 |
|---------|--------|------|----------|
| 入力 | テキスト入力 | ユーザーが飲食店検索条件を自由入力 | ✅ |
| 処理 | 初回グラウンディングサーチ | 入力から10件の飲食店を検索 | ✅ |
| 処理 | 店舗名抽出 | 検索結果からAIで店舗名を抽出 | ✅ |
| 入力 | 店舗選択 | ユーザーが詳細検索対象の店舗を選択（チェックボックス） | ✅ |
| 処理 | 個別店舗サーチ | 選択された店舗を順次詳細検索 | ✅ |
| 処理 | 合致度判定 | 検索結果と入力の合致度を5段階判定 | ✅ |
| 出力 | 詳細表示 | 各ステップのプロンプト・結果を表示 | ✅ |
| メンテナンス | ログ出力 | バックエンド・フロントエンドのデバッグログ | ✅ |

---

## 1.2 技術スタック選定・選定根拠

| 分類 | 技術 | 選定根拠 | 実装バージョン |
|------|------|----------|----------------|
| **バックエンド言語** | Python 3.11+ | Google AI SDK（google-genai）の公式サポート | ✅ |
| **バックエンドFW** | FastAPI | 非同期処理、自動APIドキュメント生成、型安全性 | ✅ |
| **フロントエンド** | HTML + Vanilla JavaScript | シンプルな検証用途、追加ビルド不要 | ✅ |
| **CSSフレームワーク** | なし（カスタムCSS） | 軽量、検証目的に十分 | ✅ |
| **Google AI SDK** | google-genai | Gemini API + Grounding Search対応（新SDK） | ✅ |
| **Geminiモデル** | gemini-2.5-flash | Grounding Search対応、高速応答 | ✅ 実装版 |
| **ログ管理** | Python logging | 標準ライブラリ、ファイル＋コンソール出力対応 | ✅ |
| **環境変数管理** | python-dotenv | .envファイルからAPIキー読み込み | ✅ |
| **CORS対応** | fastapi[cors] | フロントエンドとバックエンド間通信 | ✅ |
| **バリデーション** | Pydantic | リクエスト・レスポンスの型安全性 | ✅ |

---

## 1.3 機能詳細化（実装版）

### 主要機能1: テキスト入力・表示
- ✅ 1.1 入力テキストエリアの提供（3行、プレースホルダー付き）
- ✅ 1.2 検索実行ボタン（Enterキー対応）
- ✅ 1.3 入力内容・使用プロンプト・モデル名の詳細表示（Step 1）

### 主要機能2: 初回グラウンディングサーチ（10件飲食店取得）
- ✅ 2.1 入力テキストからプロンプト生成
- ✅ 2.2 Gemini API + Grounding Search呼び出し
- ✅ 2.3 サーチ結果の詳細表示（生レスポンス＋グラウンディングメタデータ、Step 2）

### 主要機能3: 店舗名抽出・店舗選択
- ✅ 3.1 サーチ結果テキストからAIで店舗名を10件抽出（Pydanticスキーマ使用）
- ✅ 3.2 抽出プロンプト・結果の詳細表示
- ✅ 3.3 店舗リストの構造化（JSON形式）
- ✅ 3.4 各店舗にチェックボックスを表示（**デフォルト: 全未選択**）
- ✅ 3.5 ユーザーが詳細検索対象の店舗を選択/解除
- ✅ 3.6 「個別店舗サーチ開始」ボタンを表示（選択時のみ表示）
- ✅ 3.7 フォールバック処理（Pydantic検証失敗時の正規表現抽出）

### 主要機能4: 個別店舗サーチ（順次実行）
- ✅ 4.1 選択された店舗に対する検索プロンプト生成
- ✅ 4.2 Grounding Search呼び出し（選択店舗を順次処理、500ms間隔）
- ✅ 4.3 各店舗サーチ結果の詳細表示（Step 4、折りたたみ可能）
- ✅ 4.4 エラーハンドリング（個別店舗のエラーをサマリーに含める）
- ✅ 4.5 ソースURL表示（v1.1追加）
  - groundingMetadata.groundingChunksからURLとタイトルを抽出
  - 各店舗の詳細サーチ結果の下に「参照元URL」セクションを表示
  - リンクは新しいタブで開く、タイトルが利用可能な場合は表示

### 主要機能5: 合致度判定
- ✅ 5.1 各店舗結果と入力テキストの合致度をAI判定（Pydanticスキーマ使用）
- ✅ 5.2 5段階評価（1:まったく合致しない ～ 5:完全に合致）
- ✅ 5.3 判定理由・結果の詳細表示（Step 4内）
- ✅ 5.4 全店舗の判定結果サマリー表示（Step 5、テーブル形式）
- ✅ 5.5 スコア別色分け（1=赤、2=オレンジ、3=黄、4=緑、5=濃緑）

### 主要機能6: ログ・デバッグ機能
- ✅ 6.1 バックエンド：処理単位ごとのログ（コンソール＋ファイル `logs/app.log`）
- ✅ 6.2 フロントエンド：API呼び出し・結果取得のブラウザコンソールログ
- ✅ 6.3 ログレベル：DEBUG（開発時）、環境変数で変更可能

---

## 1.4 データモデル・データ構造定義（実装版）

### リクエスト/レスポンス構造（API通信）

```python
# リクエスト
SearchRequest:
  - input_text: str          # ユーザー入力テキスト (min_length=1)

ShopDetailRequest:
  - input_text: str          # 元の入力テキスト
  - shop_names: List[str]    # 選択された店舗名リスト (min_items=1)

# レスポンス
InitialSearchResponse:
  - input_text: str          # 入力テキスト
  - prompt_used: str         # 使用したプロンプト（実装版: promptからprompt_usedに変更）
  - model_name: str          # 使用モデル名（実装値: "gemini-2.5-flash"）
  - raw_response: str        # Gemini生レスポンス
  - grounding_metadata: Optional[dict]  # グラウンディング情報
  - shop_list: ShopListData  # 抽出された店舗リスト

ShopListData:
  - shops: List[str]         # 店舗名リスト（最大10件）

ShopDetailSearchResponse:
  - input_text: str          # 元の入力テキスト
  - shop_names: List[str]    # 検索された店舗名
  - summaries: List[SummaryData]  # 各店舗のサマリー

SummaryData:
  - shop_name: str           # 店舗名
  - detail_search_result: str  # 詳細検索結果
  - judgement: JudgementData  # 合致度判定
  - sources: List[SourceCitation]  # ソースURL（v1.1追加）

SourceCitation (v1.1追加):
  - url: str                 # 参照元URL
  - title: Optional[str]     # ページタイトル（利用可能な場合）

JudgementData:
  - shop_name: str           # 店舗名
  - score: int               # 合致度スコア（1-5、実装版: Literal型からint型に変更）
  - reason: str              # 判定理由
  - search_result: str       # 検索結果テキスト
```

### AI内部スキーマ（構造化出力用）

```python
ShopListSchema:
  - shops: List[str]         # 店舗名リスト（最大10件）

JudgementSchema:
  - score: int (ge=1, le=5)  # 合致度スコア（実装版: int型、範囲バリデーション）
  - reason: str              # 判定理由（100文字以内）
```

---

## 1.5 画面設計・UI仕様（実装版）

### メイン画面レイアウト

```
+------------------------------------------------------------------+
| 🍽️ 飲食店検索Webアプリ                                             |
| Google AI Grounding Search 検証ツール                               |
+------------------------------------------------------------------+
| 検索条件を入力してください:                                          |
| +--------------------------------------------------------------+ |
| | 例: 渋谷駅周辺でラーメンが美味しい店                              | |
| |                                                              | |
| +--------------------------------------------------------------+ |
| [ 🔍 検索開始 ]                                                    |
+------------------------------------------------------------------+

[エラー表示エリア - 必要時のみ表示]

[ローディング表示 - 検索中のみ表示]

+------------------------------------------------------------------+
|  ▼ Step 1: 入力詳細                               [折りたたみ可能]|
| +--------------------------------------------------------------+ |
| |  入力テキスト: 「渋谷駅周辺でラーメンが美味しい店」                 | |
| |  使用プロンプト: 「渋谷駅周辺でラーメンが美味しい店 に合う...」      | |
| |  モデル名: gemini-2.5-flash                                    | |
| +--------------------------------------------------------------+ |
+------------------------------------------------------------------+
|  ▼ Step 2: 初回サーチ結果                         [折りたたみ可能]|
| +--------------------------------------------------------------+ |
| |  [Gemini生レスポンス]                                         | |
| |  （スクロール可能なテキストボックス、最大400px）                   | |
| |  [グラウンディング情報]                                        | |
| |  {"search_enabled": true, "model": "gemini-2.5-flash"}       | |
| +--------------------------------------------------------------+ |
+------------------------------------------------------------------+
|  ▼ Step 3: 抽出された店舗一覧                     [折りたたみ可能]|
| +--------------------------------------------------------------+ |
| |  検索したい店舗を選択してください:                               | |
| |  [ ] 一蘭 渋谷店                                              | |
| |  [ ] 博多一風堂 渋谷店                                         | |
| |  [ ] 麺屋武蔵 渋谷店                                          | |
| |  ...（最大10件）                                              | |
| |  [ 🔍 個別店舗サーチ開始 ]  (選択時のみ表示)                      | |
| +--------------------------------------------------------------+ |
+------------------------------------------------------------------+

[個別店舗検索中ローディング - 実行中のみ表示]

+------------------------------------------------------------------+
|  ▼ Step 4-1: 一蘭 渋谷店 の詳細サーチ結果         [折りたたみ可能]|
| +--------------------------------------------------------------+ |
| |  店舗名: 一蘭 渋谷店                                           | |
| |  サーチ結果: （詳細情報...）                                    | |
| |  合致度スコア: [ 5 ] (緑色バッジ)                               | |
| |  判定理由: 検索条件のすべての要素を満たしている                    | |
| +--------------------------------------------------------------+ |
+------------------------------------------------------------------+
（選択した店舗数分繰り返し）

+------------------------------------------------------------------+
|  ▼ Step 5: サマリー (合致度一覧)                  [折りたたみ可能]|
| +--------------------------------------------------------------+ |
| |  店舗名              | 合致度 | 判定理由                        | |
| |  一蘭 渋谷店          | [ 5 ] | 検索条件のすべての要素を満たす    | |
| |  博多一風堂 渋谷店     | [ 4 ] | 主要な条件を満たすが一部不明     | |
| |  ...                |       |                                | |
| +--------------------------------------------------------------+ |
+------------------------------------------------------------------+
```

### UI実装の特徴

- ✅ **レスポンシブデザイン**: 最大幅1200px、中央配置
- ✅ **折りたたみ機能**: 各ステップボックスはクリックで展開/折りたたみ可能
- ✅ **スコア色分け**:
  - スコア1: 赤 (#e74c3c)
  - スコア2: オレンジ (#e67e22)
  - スコア3: 黄 (#f39c12)
  - スコア4: 明緑 (#2ecc71)
  - スコア5: 濃緑 (#27ae60)
- ✅ **ローディング表示**: スピナーアニメーション + 説明テキスト
- ✅ **エラー表示**: 赤背景の通知エリア

---

## 1.6 API仕様（実装版）

### エンドポイント一覧

| メソッド | パス | 説明 | 実装状況 |
|---------|------|------|----------|
| GET | `/` | メインHTML配信 | ✅ |
| GET | `/health` | ヘルスチェック | ✅ |
| GET | `/static/*` | 静的ファイル配信 | ✅ |
| POST | `/api/search` | 初回検索（Step 1-3） | ✅ |
| POST | `/api/search/detail` | 個別店舗検索（Step 4-5） | ✅ |

### POST /api/search

**リクエスト**:
```json
{
  "input_text": "渋谷駅周辺でラーメンが美味しい店"
}
```

**レスポンス**:
```json
{
  "input_text": "渋谷駅周辺でラーメンが美味しい店",
  "prompt_used": "「渋谷駅周辺でラーメンが美味しい店」に合う飲食店を10件リストアップ...",
  "model_name": "gemini-2.5-flash",
  "raw_response": "渋谷駅周辺でラーメンが美味しいお店を10件ご紹介します...",
  "grounding_metadata": {
    "search_enabled": true,
    "model": "gemini-2.5-flash"
  },
  "shop_list": {
    "shops": ["一蘭 渋谷店", "博多一風堂 渋谷店", ...]
  }
}
```

### POST /api/search/detail

**リクエスト**:
```json
{
  "input_text": "渋谷駅周辺でラーメンが美味しい店",
  "shop_names": ["一蘭 渋谷店", "博多一風堂 渋谷店"]
}
```

**レスポンス**:
```json
{
  "input_text": "渋谷駅周辺でラーメンが美味しい店",
  "shop_names": ["一蘭 渋谷店", "博多一風堂 渋谷店"],
  "summaries": [
    {
      "shop_name": "一蘭 渋谷店",
      "detail_search_result": "一蘭 渋谷店は...",
      "judgement": {
        "shop_name": "一蘭 渋谷店",
        "score": 5,
        "reason": "検索条件のすべての要素を満たしている",
        "search_result": "一蘭 渋谷店は..."
      }
    },
    ...
  ]
}
```

---

## 1.7 ファイル構成（実装版）

```
restaurant_tst5_python/
├── main.py                          # FastAPIエントリーポイント (78行)
├── requirements.txt                 # Python依存関係 (6行)
├── .env                            # 環境変数（非コミット）
├── .env.example                    # 環境変数テンプレート (3行)
├── .gitignore                      # Git除外設定 (10行)
├── SPEC.md                         # 仕様書（計画版）
├── SPEC_DETAIL.md                  # 詳細設計書（計画版）
├── SPEC_LOGIC.md                   # ロジック設計書（計画版）
├── SPEC_VALIDATION.md              # 整合性確認書
├── SPEC_VER1.0.md                  # 仕様書（実装版） ★ NEW
├── SPEC_DETAIL_VER1.0.md           # 詳細設計書（実装版） ★ NEW
├── SPEC_LOGIC_VER1.0.md            # ロジック設計書（実装版） ★ NEW
├── SPEC_VALIDATION_VER1.0.md       # 最終確認書（実装版） ★ NEW
├── app/
│   ├── __init__.py                 # パッケージ初期化
│   ├── config.py                   # 設定管理 (42行)
│   ├── logger.py                   # ログ設定 (68行)
│   ├── routers/
│   │   ├── __init__.py
│   │   └── search.py              # 検索APIルーター (63行)
│   ├── services/
│   │   ├── __init__.py
│   │   ├── gemini_service.py      # Google AI統合 (124行)
│   │   └── search_service.py      # ビジネスロジック (310行)
│   └── schemas/
│       ├── __init__.py
│       └── search.py              # Pydanticスキーマ (59行)
├── static/
│   ├── index.html                  # メインUI (139行)
│   ├── style.css                   # スタイル (295行)
│   └── app.js                      # フロントエンドロジック (177行)
└── logs/
    └── app.log                     # アプリケーションログ（自動生成）
```

**実装ファイル行数サマリー**:
- 全ファイル800行以下を達成 ✅
- 最大ファイル: search_service.py (310行)
- 最小ファイル: .env.example (3行)

---

## 1.8 セキュリティ・保守性（実装版）

### セキュリティ対策

| 項目 | 対策内容 | 実装状況 |
|------|----------|----------|
| APIキー保護 | .envファイル管理、.gitignoreで除外 | ✅ |
| 入力検証 | Pydanticによるバリデーション | ✅ |
| CORS設定 | localhost:8000のみ許可 | ✅ |
| エラー情報 | 開発環境で詳細表示、本番では非表示 | ✅ |
| ログ保護 | APIキーをログに出力しない | ✅ |

### 保守性

| 項目 | 対策内容 | 実装状況 |
|------|----------|----------|
| 型安全性 | Pydantic、型ヒント使用 | ✅ |
| ログ出力 | 処理単位での詳細ログ | ✅ |
| エラーハンドリング | try-except、フォールバック処理 | ✅ |
| ファイル分割 | 機能単位で適切に分割 | ✅ |
| コメント | 各関数にdocstring | ✅ |

---

## 1.9 実装時の技術的選択

### Pydanticスキーマの型選択

**計画版**: `score: Literal[1, 2, 3, 4, 5]`
**実装版**: `score: int = Field(ge=1, le=5)`

**理由**: Gemini APIのJSON Schema変換時に、Literal型が文字列として解釈されるバリデーションエラーが発生。int型with範囲バリデーションに変更することで解決。

### チェックボックスのデフォルト状態

**計画版**: 全選択
**実装版**: 全未選択

**理由**: ユーザーが明示的に選択することで、意図しない大量API呼び出しを防止。UX向上。

### レート制限の実装

**実装**: 各店舗検索の間に500ms待機
**場所**: `search_service.py` の `detail_search()` メソッド

```python
if i < len(shop_names):
    logger.debug(f"[Rate Limit] Waiting 500ms before next shop...")
    time.sleep(0.5)
```

---

## 1.10 テスト・検証（実装版）

### 動作確認済み機能

- ✅ Step 1-3: 初回検索と店舗名抽出
- ✅ チェックボックス選択とボタン表示制御
- ✅ Step 4-5: 個別店舗検索と合致度判定
- ✅ スコア色分け表示
- ✅ エラーハンドリング（API失敗、個別店舗エラー）
- ✅ ログ出力（バックエンド: console + file、フロントエンド: console）
- ✅ レート制限（500ms間隔）
- ✅ 折りたたみ機能
- ✅ レスポンシブデザイン

### 検証済みシナリオ

1. **正常系**: 渋谷駅周辺のラーメン店検索
2. **正常系**: みなとみらいの天ぷら店検索
3. **エラー系**: 空入力 → バリデーションエラー
4. **エラー系**: APIキー不正 → エラーメッセージ表示

---

## 終わりに

本仕様書VER1.0は、計画版(SPEC.md)に基づいて実装された機能を正確に反映したドキュメントです。計画と実装の差分を明確にし、今後のメンテナンスや機能追加の参考資料として活用できます。

**実装完了日**: 2026-01-19
**実装者**: Claude Sonnet 4.5
**総実装時間**: 6ステージ（段階的実装・テスト）
